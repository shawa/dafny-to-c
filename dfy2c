 #!/bin/sh

readonly INFILE="$1"
readonly OUTFILE="$INFILE.c"

REQUIRED_HEADERS_AND_TYPEDEFS="#include <stdio.h>
//generated by dfy2c
#include <stdbool.h>
#include <stdint.h>
#include <string.h>
#include <stdlib.h>

typedef char* string;
typedef uint64_t nat;
// end generated by dfy2c
"

sed "/^ \+\(requires\|invariant\|decreases\|ensures\)/d;
    s/^ \+var//g;
    s/^\(method\|function\|predicate\) //;
    s/^\(\w\+(.\+)\) returns (\w\+: \(\w\+\))/\2 \1/;
    s/:=/=/g;
    s/\(\w\+\): \(\w\+\)/\2 \1/g;
    s/\(\w\+\)\[\(.*\?\)\.\.]/slice(\1, \2, strlen(\1))/;
    s/\(\w\+\)\[\.\.\(.*\?\)]/slice(\1, 0, \2)/;
    s/\(\w\+\)\[\(.*\?\)\.\.\(.*\?\)]/slice(\1, \2, \3)/;
    s/|\(\w\+\)|/strlen(\1)/g" "$INFILE" \
        | echo "$REQUIRED_HEADERS_AND_TYPEDEFS$(cat -)" > "$OUTFILE"
